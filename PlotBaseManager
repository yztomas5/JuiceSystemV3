--// ServerScript - PlotBaseManager
--// Maneja la visualizaci√≥n de bases seg√∫n Rebirth y la gesti√≥n de plots

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

-- Referencias a las carpetas de assets
local baseFolder = ReplicatedStorage:WaitForChild("Assets"):WaitForChild("Models"):WaitForChild("Plot"):WaitForChild("Base")
local noPlayerModel = baseFolder:WaitForChild("NoPlayer")

-- Referencia a las plots en Workspace
local plotsFolder = Workspace:WaitForChild("Plots")

-- Tabla para trackear qu√© jugador est√° en qu√© plot
local plotOwners = {}  -- [plotName] = player


--------------------------------------------------------------
-- LIMPIAR MODELOS ANTERIORES EN CURRENTREBIRTH
--------------------------------------------------------------
local function clearCurrentRebirth(plotModel)
	if not plotModel then return end

	local baseFolder = plotModel:FindFirstChild("Base")
	if not baseFolder then return end

	local currentRebirthFolder = baseFolder:FindFirstChild("CurrentRebirth")
	if not currentRebirthFolder then return end

	-- Eliminar TODOS los modelos excepto Position
	for _, child in ipairs(currentRebirthFolder:GetChildren()) do
		if child.Name ~= "Position" and child ~= currentRebirthFolder:FindFirstChild("Position") then
			child:Destroy()
		end
	end
end


--------------------------------------------------------------
-- ENCONTRAR EL MODELO DE REBIRTH M√ÅS CERCANO (PARA CARGA INICIAL)
--------------------------------------------------------------
local function findClosestRebirthModel(rebirthValue)
	local closestModel = nil
	local closestRebirth = -1

	print("[PlotBaseManager] üîç Buscando modelo m√°s cercano para Rebirth:", rebirthValue)
	print("[PlotBaseManager] üìÅ Modelos disponibles en baseFolder:")
	for _, child in ipairs(baseFolder:GetChildren()) do
		print("  - " .. child.Name .. " (tonumber: " .. tostring(tonumber(child.Name)) .. ")")
	end

	-- Buscar todos los modelos num√©ricos en Base
	for _, model in ipairs(baseFolder:GetChildren()) do
		local modelRebirth = tonumber(model.Name)

		if modelRebirth then
			print("[PlotBaseManager] üî¢ Evaluando modelo:", model.Name, "| Valor:", modelRebirth)

			-- Si el modelo es exacto, retornarlo inmediatamente
			if modelRebirth == rebirthValue then
				print("[PlotBaseManager] ‚úÖ MATCH EXACTO encontrado:", model.Name)
				return model
			end

			-- Si es menor o igual al rebirth del jugador y es el m√°s alto encontrado
			if modelRebirth <= rebirthValue and modelRebirth > closestRebirth then
				print("[PlotBaseManager] ‚¨ÜÔ∏è Nuevo modelo m√°s cercano:", model.Name, "| closestRebirth:", closestRebirth, "‚Üí", modelRebirth)
				closestRebirth = modelRebirth
				closestModel = model
			else
				print("[PlotBaseManager] ‚è≠Ô∏è Modelo descartado:", model.Name, "| Raz√≥n: modelRebirth > rebirthValue O modelRebirth <= closestRebirth")
			end
		end
	end

	-- Si no se encontr√≥ ninguno, buscar el modelo "0"
	if not closestModel then
		print("[PlotBaseManager] ‚ö†Ô∏è No se encontr√≥ ning√∫n modelo v√°lido, usando modelo 0")
		closestModel = baseFolder:FindFirstChild("0")
	else
		print("[PlotBaseManager] ‚úÖ Modelo final seleccionado:", closestModel.Name, "para Rebirth", rebirthValue)
	end

	return closestModel
end


--------------------------------------------------------------
-- ‚ö° BUSCAR MODELO EXACTO PARA UN REBIRTH ESPEC√çFICO
-- Solo retorna modelo si existe con el n√∫mero EXACTO
--------------------------------------------------------------
local function findExactRebirthModel(rebirthValue)
	local modelName = tostring(rebirthValue)
	print("[PlotBaseManager] üîç Buscando modelo EXACTO para Rebirth:", rebirthValue, "| Nombre buscado:", modelName)

	local exactModel = baseFolder:FindFirstChild(modelName)

	if exactModel then
		print("[PlotBaseManager] ‚úÖ Modelo exacto encontrado para Rebirth " .. rebirthValue)
		return exactModel
	else
		print("[PlotBaseManager] ‚ÑπÔ∏è No hay modelo espec√≠fico para Rebirth " .. rebirthValue .. ", manteniendo modelo actual")
		return nil
	end
end


--------------------------------------------------------------
-- CAMBIAR TRANSPARENCIA, COLISI√ìN Y CANTOUCH DE UN MODELO
-- EXCEPTO LA PARTE "Collect" Y LAS TOOLS
--------------------------------------------------------------
local function setModelVisibility(model, isVisible)
	if not model then return end
	for _, descendant in ipairs(model:GetDescendants()) do
		if descendant:IsA("BasePart") then
			-- EXCEPCI√ìN 1: No tocar la parte "Collect"
			if descendant.Name == "Collect" then
				continue
			end

			-- EXCEPCI√ìN 2: No tocar partes que sean hijos de una Tool
			local isInsideTool = false
			local parent = descendant.Parent
			while parent do
				if parent:IsA("Tool") then
					isInsideTool = true
					break
				end
				parent = parent.Parent
			end

			if isInsideTool then
				continue
			end

			-- Aplicar cambios
			if isVisible then
				descendant.Transparency = 0
				descendant.CanCollide = true
				descendant.CanTouch = true
			else
				descendant.Transparency = 1
				descendant.CanCollide = false
				descendant.CanTouch = false
			end
		end
	end
end


--------------------------------------------------------------
-- ACTUALIZAR VISIBILIDAD DE SLOTS (SIN BILLBOARDS)
--------------------------------------------------------------
local function updateSlotsVisibility(clonedModel, slotsValue)
	if not clonedModel then return end

	local slotsFolder = clonedModel:FindFirstChild("Slots")
	if not slotsFolder then return end

	-- Actualizar Buy (solo visible el SIGUIENTE slot)
	local buyFolder = slotsFolder:FindFirstChild("Buy")
	if buyFolder then
		for _, child in ipairs(buyFolder:GetChildren()) do
			local slotNumber = tonumber(child.Name)
			if slotNumber then
				local shouldBeVisible = slotNumber == slotsValue + 1
				setModelVisibility(child, shouldBeVisible)
			end
		end
	end

	-- Actualizar Place (visible desde 1 hasta slotsValue)
	local placeFolder = slotsFolder:FindFirstChild("Place")
	if placeFolder then
		for _, child in ipairs(placeFolder:GetChildren()) do
			local slotNumber = tonumber(child.Name)
			if slotNumber then
				setModelVisibility(child, slotNumber <= slotsValue)
			end
		end
	end
end


--------------------------------------------------------------
-- CLONAR Y POSICIONAR UN MODELO EN CURRENTREBIRTH
--------------------------------------------------------------

local function cloneAndPositionBase(template, plotModel, player, plotName)
	if not template or not plotModel then return end

	local baseFolder = plotModel:FindFirstChild("Base")
	if not baseFolder then return end

	local currentRebirthFolder = baseFolder:FindFirstChild("CurrentRebirth")
	if not currentRebirthFolder then return end

	local positionPart = currentRebirthFolder:FindFirstChild("Position")
	if not positionPart then return end

	-- CR√çTICO: Limpiar PRIMERO todos los modelos anteriores
	clearCurrentRebirth(plotModel)

	-- Clonar el template
	local clone = template:Clone()

	-- Guardar la posici√≥n y orientaci√≥n target
	local targetCFrame = positionPart.CFrame

	-- CAMBIAR POSICI√ìN Y ORIENTACI√ìN
	if clone:IsA("Model") then
		-- Aplicar el CFrame completo (posici√≥n + orientaci√≥n) de la parte Position
		clone:PivotTo(targetCFrame)

	elseif clone:IsA("BasePart") then
		-- Para partes simples, aplicar el CFrame completo
		clone.CFrame = targetCFrame
	end

	-- Parentear el modelo clonado DESPU√âS de posicionarlo
	clone.Parent = currentRebirthFolder

	-- Actualizar visibilidad de slots si hay jugador
	if player then
		local dataFolder = player:FindFirstChild("Data")
		if dataFolder then
			local slotsValue = dataFolder:FindFirstChild("Slots")
			if slotsValue and slotsValue:IsA("IntValue") then
				updateSlotsVisibility(clone, slotsValue.Value)
			end
		end
	end

	return clone
end


--------------------------------------------------------------
-- ACTUALIZAR BASE DE UNA PLOT (CARGA INICIAL)
--------------------------------------------------------------
local function updatePlotBase(plotName, player)
	if not plotName or plotName == "" then return end

	local plotModel = plotsFolder:FindFirstChild(plotName)
	if not plotModel then return end

	-- Si no hay jugador, poner NoPlayer
	if not player then
		cloneAndPositionBase(noPlayerModel, plotModel, nil, plotName)
		return
	end

	-- Obtener el Rebirth del jugador
	local dataFolder = player:FindFirstChild("Data")
	if not dataFolder then
		cloneAndPositionBase(noPlayerModel, plotModel, nil, plotName)
		return
	end

	local rebirthValue = dataFolder:FindFirstChild("Rebirth")
	if not rebirthValue or not rebirthValue:IsA("IntValue") then
		cloneAndPositionBase(noPlayerModel, plotModel, nil, plotName)
		return
	end

	-- Encontrar el modelo correspondiente al Rebirth (busca el m√°s cercano)
	local rebirthModel = findClosestRebirthModel(rebirthValue.Value)

	if rebirthModel then
		cloneAndPositionBase(rebirthModel, plotModel, player, plotName)
	else
		cloneAndPositionBase(noPlayerModel, plotModel, nil, plotName)
	end
end


--------------------------------------------------------------
-- ‚ö° ACTUALIZAR BASE SOLO SI EXISTE MODELO EXACTO (REBIRTH CHANGE)
--------------------------------------------------------------
local function updatePlotBaseOnRebirthChange(plotName, player, newRebirthValue)
	if not plotName or plotName == "" then return end
	if not player then return end

	local plotModel = plotsFolder:FindFirstChild(plotName)
	if not plotModel then return end

	-- ‚ö° BUSCAR MODELO EXACTO
	local exactModel = findExactRebirthModel(newRebirthValue)

	-- Solo cambiar si existe modelo exacto
	if exactModel then
		print("[PlotBaseManager] üîÑ Cambiando a modelo de Rebirth " .. newRebirthValue)
		cloneAndPositionBase(exactModel, plotModel, player, plotName)
	else
		print("[PlotBaseManager] ‚è∏Ô∏è No hay cambio de modelo para Rebirth " .. newRebirthValue)
		-- NO hacer nada - mantener el modelo actual
	end
end


--------------------------------------------------------------
-- OBTENER JUGADOR DUE√ëO DE UNA PLOT (FUNCI√ìN P√öBLICA)
--------------------------------------------------------------
function getPlotOwner(plotName)
	return plotOwners[plotName]
end


--------------------------------------------------------------
-- CONFIGURAR VIGILANCIA PARA UN JUGADOR
--------------------------------------------------------------
local function setupPlayerWatcher(player)
	-- Esperar CurrentPlot
	local currentPlotValue = player:WaitForChild("CurrentPlot", 10)
	if not currentPlotValue or not currentPlotValue:IsA("StringValue") then return end

	-- Esperar Data y Rebirth
	local dataFolder = player:WaitForChild("Data", 10)
	local rebirthValue
	local slotsValue

	if dataFolder then
		rebirthValue = dataFolder:WaitForChild("Rebirth", 10)
		slotsValue = dataFolder:WaitForChild("Slots", 10)
	end

	-- Funci√≥n para actualizar cuando cambia la plot
	local function updatePlayer()
		local plotName = currentPlotValue.Value

		-- Limpiar plot anterior si existe
		for oldPlotName, oldPlayer in pairs(plotOwners) do
			if oldPlayer == player and oldPlotName ~= plotName then
				plotOwners[oldPlotName] = nil
				updatePlotBase(oldPlotName, nil)  -- Poner NoPlayer en la plot anterior
			end
		end

		-- Actualizar nueva plot
		if plotName ~= "" then
			plotOwners[plotName] = player
			updatePlotBase(plotName, player)  -- Usa findClosest para carga inicial
		end
	end

	-- Escuchar cambios en CurrentPlot
	currentPlotValue:GetPropertyChangedSignal("Value"):Connect(updatePlayer)

	-- ‚ö° Escuchar cambios en Rebirth - SOLO CAMBIA SI EXISTE MODELO EXACTO
	if rebirthValue and rebirthValue:IsA("IntValue") then
		rebirthValue:GetPropertyChangedSignal("Value"):Connect(function()
			local plotName = currentPlotValue.Value
			if plotName ~= "" then
				-- Usar la nueva funci√≥n que solo cambia si existe modelo exacto
				updatePlotBaseOnRebirthChange(plotName, player, rebirthValue.Value)
			end
		end)
	end

	-- Escuchar cambios en Slots (solo actualiza visibilidad)
	if slotsValue and slotsValue:IsA("IntValue") then
		slotsValue:GetPropertyChangedSignal("Value"):Connect(function()
			local plotName = currentPlotValue.Value
			if plotName ~= "" then
				-- Buscar el modelo clonado actual
				local plotModel = plotsFolder:FindFirstChild(plotName)
				if plotModel then
					local baseFolder = plotModel:FindFirstChild("Base")
					if baseFolder then
						local currentRebirthFolder = baseFolder:FindFirstChild("CurrentRebirth")
						if currentRebirthFolder then
							-- Buscar el modelo clonado (no Position)
							for _, child in ipairs(currentRebirthFolder:GetChildren()) do
								if child.Name ~= "Position" and child:IsA("Model") then
									updateSlotsVisibility(child, slotsValue.Value)
									break
								end
							end
						end
					end
				end
			end
		end)
	end

	-- Actualizar inmediatamente si ya tiene una plot asignada
	if currentPlotValue.Value ~= "" then
		updatePlayer()
	end
end


--------------------------------------------------------------
-- LIMPIAR CUANDO UN JUGADOR SE VA
--------------------------------------------------------------
local function onPlayerRemoving(player)
	-- Limpiar plots del jugador
	for plotName, owner in pairs(plotOwners) do
		if owner == player then
			plotOwners[plotName] = nil
			updatePlotBase(plotName, nil)  -- Poner NoPlayer
		end
	end
end


--------------------------------------------------------------
-- INICIALIZACI√ìN
--------------------------------------------------------------
Players.PlayerAdded:Connect(setupPlayerWatcher)
Players.PlayerRemoving:Connect(onPlayerRemoving)

-- Configurar jugadores que ya est√°n en el servidor
for _, player in ipairs(Players:GetPlayers()) do
	task.spawn(function()
		setupPlayerWatcher(player)
	end)
end


--------------------------------------------------------------
-- EXPONER FUNCI√ìN GLOBAL PARA OTROS SCRIPTS
--------------------------------------------------------------
_G.GetPlotOwner = getPlotOwner

print("[PlotBaseManager] ‚úÖ Sistema de gesti√≥n de plots iniciado")
