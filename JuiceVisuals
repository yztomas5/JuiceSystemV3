local ReplicatedStorage = game:GetService("ReplicatedStorage")

local JuiceVisuals = {}

local IngredientConfig = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Config"):WaitForChild("IngredientConfig"))
local GradientEffects = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Utils"):WaitForChild("GradientEffects"))

local juiceVFX = ReplicatedStorage:WaitForChild("Assets"):WaitForChild("VFX"):WaitForChild("Juice")
local infoGuiTemplate = ReplicatedStorage:WaitForChild("Assets"):WaitForChild("GUI"):WaitForChild("Billboards"):WaitForChild("InfoGui")

function JuiceVisuals.mixColors(colors)
	if #colors == 0 then
		return Color3.fromRGB(255, 255, 255)
	end

	local r, g, b = 0, 0, 0
	for _, color in ipairs(colors) do
		r = r + color.R
		g = g + color.G
		b = b + color.B
	end

	return Color3.new(r / #colors, g / #colors, b / #colors)
end

function JuiceVisuals.getIngredientsColors(ingredientsFolder)
	local colors = {}

	if ingredientsFolder then
		for _, ingredientFolder in ipairs(ingredientsFolder:GetChildren()) do
			if ingredientFolder:IsA("Folder") then
				local ingredientData = IngredientConfig.Ingredients[ingredientFolder.Name]
				if ingredientData and ingredientData.Color then
					table.insert(colors, ingredientData.Color)
				end
			end
		end
	end

	return colors
end

function JuiceVisuals.getMixedColorFromIngredients(ingredientsFolder)
	local colors = JuiceVisuals.getIngredientsColors(ingredientsFolder)
	return JuiceVisuals.mixColors(colors)
end

function JuiceVisuals.applyJuiceTextures(tool, color)
	local model = tool:FindFirstChild("Model")
	if not model then return end

	local contentPart = model:FindFirstChild("Content")
	if not contentPart then return end

	for _, child in ipairs(contentPart:GetChildren()) do
		if child:IsA("Texture") or child:IsA("Decal") then
			child:Destroy()
		end
	end

	local vfxContent = juiceVFX:FindFirstChild("Content")
	if not vfxContent then return end

	local contentClone = vfxContent:Clone()

	for _, texture in ipairs(contentClone:GetChildren()) do
		if texture:IsA("Texture") or texture:IsA("Decal") then
			texture.Color3 = color
			texture.Parent = contentPart
		end
	end

	contentClone:Destroy()
end

function JuiceVisuals.setupJuiceInfoGui(tool, juiceName, price, pricePerSec, quality, moneyGeneratedValue, formatNumberFunc)
	local display = tool:FindFirstChild("Display")
	if not display then return end

	local infoGui = display:FindFirstChild("InfoGui")
	if not infoGui then return end

	local nameLabel = infoGui:FindFirstChild("Name")
	if nameLabel and nameLabel:IsA("TextLabel") then
		nameLabel.Text = juiceName
	end

	local rarityLabel = infoGui:FindFirstChild("Rarity")
	if rarityLabel and rarityLabel:IsA("TextLabel") then
		rarityLabel.Text = quality
		GradientEffects.applyQualityGradient(rarityLabel, quality)
	end

	local priceLabel = infoGui:FindFirstChild("Price")
	if priceLabel and priceLabel:IsA("TextLabel") then
		priceLabel.Text = formatNumberFunc(price)
	end

	local pricePerSecLabel = infoGui:FindFirstChild("PricePerSec")
	if pricePerSecLabel and pricePerSecLabel:IsA("TextLabel") then
		local function updatePricePerSecLabel()
			local moneyGenerated = moneyGeneratedValue and moneyGeneratedValue.Value or 0
			pricePerSecLabel.Text = formatNumberFunc(pricePerSec) .. "/s (" .. formatNumberFunc(moneyGenerated) .. ")"
		end


		updatePricePerSecLabel()

		if moneyGeneratedValue then
			moneyGeneratedValue:GetPropertyChangedSignal("Value"):Connect(updatePricePerSecLabel)
		end
	end
end

function JuiceVisuals.createIngredientsBillboard(slotModel, ingredientsFolder)
	local slotBasePart = slotModel:FindFirstChild("Base")
	if not slotBasePart or not slotBasePart:IsA("BasePart") then return end

	local billboardGui = infoGuiTemplate:Clone()
	billboardGui.Name = "IngredientsInfo"
	billboardGui.Parent = slotBasePart

	local content = billboardGui:FindFirstChild("Content")
	if not content then return end

	local template = content:FindFirstChild("Template")
	if not template then return end

	template.Visible = false

	if ingredientsFolder then
		for _, ingredientFolder in ipairs(ingredientsFolder:GetChildren()) do
			if ingredientFolder:IsA("Folder") then
				local ingredientData = IngredientConfig.Ingredients[ingredientFolder.Name]
				if ingredientData then
					local ingredientFrame = template:Clone()
					ingredientFrame.Name = ingredientFolder.Name
					ingredientFrame.Visible = true

					local icon = ingredientFrame:FindFirstChild("Icon")
					local nameLabel = ingredientFrame:FindFirstChild("Name")

					if icon and icon:IsA("ImageLabel") then
						icon.Image = ingredientData.Image or ""
					end

					if nameLabel and nameLabel:IsA("TextLabel") then
						nameLabel.Text = ingredientData.Name or ingredientFolder.Name
					end

					ingredientFrame.Parent = content
				end
			end
		end
	end

	return billboardGui
end

function JuiceVisuals.getUniqueMutations(ingredientsFolder)
	local uniqueMutations = {}

	if ingredientsFolder then
		local mutationSet = {}
		for _, ingredientFolder in ipairs(ingredientsFolder:GetChildren()) do
			if ingredientFolder:IsA("Folder") then
				for _, child in ipairs(ingredientFolder:GetChildren()) do
					if child:IsA("StringValue") and not mutationSet[child.Name] then
						mutationSet[child.Name] = true
						table.insert(uniqueMutations, child.Name)
					end
				end
			end
		end
	end

	return uniqueMutations
end

function JuiceVisuals.applyMutationsToTool(tool, ingredientsFolder)
	local uniqueMutations = JuiceVisuals.getUniqueMutations(ingredientsFolder)

	local mutationFolder = tool:FindFirstChild("Mutation")
	if not mutationFolder then
		mutationFolder = Instance.new("Folder")
		mutationFolder.Name = "Mutation"
		mutationFolder.Parent = tool
	end

	for _, child in ipairs(mutationFolder:GetChildren()) do
		if child:IsA("StringValue") then
			child:Destroy()
		end
	end

	for _, mutationName in ipairs(uniqueMutations) do
		local mutationValue = Instance.new("StringValue")
		mutationValue.Name = mutationName
		mutationValue.Value = mutationName
		mutationValue.Parent = mutationFolder
	end
end

function JuiceVisuals.cleanupSlotVisuals(placeSlotModel)
	if not placeSlotModel then return end

	for _, child in ipairs(placeSlotModel:GetChildren()) do
		if child:IsA("Tool") then
			child:Destroy()
		end
	end

	local basePart = placeSlotModel:FindFirstChild("Base")
	if basePart and basePart:IsA("BasePart") then
		for _, child in ipairs(basePart:GetChildren()) do
			if child:IsA("BillboardGui") and child.Name == "IngredientsInfo" then
				child:Destroy()
			end
		end
	end
end

return JuiceVisuals
